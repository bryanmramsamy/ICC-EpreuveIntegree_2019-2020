{% extends 'base.html' %}
{% load i18n registration_extra static %}

{% block title %}{{ module.title }} | {{ module.reference }}{% endblock title %}

{% block content %}

  {# Heading jumbotron #}

  {% include 'management/module/module_detailview_jumbotron.html' %}


  {# Presentation card #}

  <section class="container p-1 p-md-3 border bg-light">
    <div class="row rwo-cols-1 row-cols-lg-2">
      <div class="col-lg-6 text-center">
        <img src="{{ module.picture.url }}" alt="{{ module.title }}" class="img-fluid" style="max-width: 400px; max-height: 300px;"/>
      </div>
      <div class="col-lg-6 text-center">
        <h1>{% include 'logo/module.html' %}</h1>
        <h2>{{ module.title }}</h2>
        <div class="row">
          <div class="col">{{ module.reference }}</div>
          <div class="col">{{ module.level.name }}</div>
        </div>
        <hr>
        <div class="row h3">
          <div class="col">ECTS: <strong>{{ module.ECTS_value }}</strong></div>
          <div class="col">â‚¬ <strong>{{ module.price }}</strong></div>
        </div>
        <hr>

        {% if module.degrees.all.count > 0 %}
        <p>{% trans 'This module is part of the following degrees' %}:</p>
        <ul class="list-unstyled">
          {% for degree in module.degrees.all %}
            <li class="h5">
              <a href="{{ degree.get_absolute_url }}" class="text-reset">
                {% include 'logo/degree.html' %} {{ degree.title }} <small class="text-muted">{{ degree.category.name }}</small>
              </a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p>{% trans 'This module does not belong to any degree.' %}</p>
        {% endif %}
        <hr>

        {% if module.eligible_teachers.all.count > 0 %}
        <p>{% trans 'Teachers of this module' %}:</p>
        <ul class="list-unstyled">
          {% for teacher in module.eligible_teachers.all %}
            <li class="h5">
              {{ teacher.get_full_name }} <a href="mailto:{{ teacher.email }}" class="badge badge-secondary">{% trans 'Contact by mail' %} {% include 'logo/mail.html' %}</a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p>{% trans 'There is actually no eligible teacher for this course.' %}</p>
        {% endif %}
      </div>
    </div>

    <hr>
    
    {% if request.user|is_manager_or_administrator %}
    <div class="row row-cols-1 row-cols-md-2">
      <div class="col mb-2 mb-md-0">
        <a href="{% url 'module_updateview' pk=module.pk %}" class="btn btn-block btn-warning">{% trans 'Update' %} {% include 'logo/edit.html' %}</a>
      </div>
      <div class="col">
        <a href="{% url 'module_deleteview' pk=module.pk %}" class="btn btn-block btn-danger">{% trans 'Delete' %} {% include 'logo/delete.html' %}</a>
      </div>
    </div>

    {% elif request.user|is_teacher %}
      <a href="404" class="btn btn-block btn-info">{% trans 'DEBUG: No functionality yet for Teachers' %} {% include 'logo/warning.html' %}</a>  <!-- TODO: add functionality -->

    {% elif request.user|is_student %}
      {# Validation restriction bubble #}

      {% if already_validated %}
        {% include 'bubbles/success_module_already_completed.html' %}

      {% else %}
        {% if module.prerequisites.all.count > 0 and all_prerequisites_validated %}
          {% include 'bubbles/info_module_prerequisites_completed.html' %}

        {% elif module.prerequisites.all.count > 0 %}
          {% include 'bubbles/warning_module_has_prerequisites.html' %}
        {% endif %}

        {% if module.postrequisites.all.count > 0 %}
          {% include 'bubbles/info_module_has_postrequisites.html' %}
        {% endif %}
      {% endif %}

      <a href="404" class="btn btn-block btn-dark">{% trans 'Subscribe to this module' %} {% include 'logo/puzzle.html' %}</a>   <!-- TODO: redirect to module_rr_createview -->

    {% elif request.user|is_guest %}
      {% include 'bubbles/warning_guest.html' %}

      <a href="{% url 'pursue_registration' %}" class="btn btn-block btn-dark">{% trans 'Complete your registration' %} {% include 'logo/register_alt.html' %}</a>

    {% else %}
      {% include 'bubbles/warning_unregistered.html' %}

      <div class="row row-cols-1 row-cols-md-2">
        <div class="col mb-2 mb-md-0">
          <a href="{% url 'register' %}" class="btn btn-block btn-dark">{% trans 'Sign up' %} {% include 'logo/register.html' %}</a>
        </div>
        <div class="col">
          <a href="{% url 'login' %}" class="btn btn-block btn-outline-dark">{% trans 'Sign in' %} {% include 'logo/in-left.html' %}</a>
        </div>
      </div>
    {% endif %}
  </section>

  <br>


  {# Prerequisites list #}

  {% if module.prerequisites.all.count > 0 %}
    <section class="container p-1 p-md-3 border">
      <div class="text-center">
        <h3>{% trans 'Prerequisites for this module' %}</h3>
      </div>
      <hr>
      {% for prerequisite in module.prerequisites.all %}
        <div class="row row-cols-1 row-cols-md-2 text-center text-md-left">
          <div class="col-md-7">
            <a href="{{ prerequisite.get_absolute_url }}" class="text-reset">
              <span class="h5">{% include 'logo/module.html' %} {{ prerequisite.title }}</span> 
              <span class="small text-muted">{{ prerequisite.reference }}</span>
            </a>
          </div>
          <div class="col-md-5">
            {% if request.user|is_student %}
              {% if request.user|module_already_validated_by_user:prerequisite %}
                <span class="text-success">{% include 'logo/check_valid.html' %} {% trans 'Module already validated' %}</span>
              {% elif request.user|all_prerequisites_validated_by_user:prerequisite %}
                <span class="text-warning">{% include 'logo/check_ready.html' %} {% trans 'Prerequisites validated' %}</span>
              {% else %}
                <span class="text-danger">{% include 'logo/check_invalid.html' %} {% trans 'Prerequisites missing' %}</span>
              {% endif %}
            {% else %}
              <span class="text-info">{% include 'logo/check_info.html' %} 
                {% blocktrans count nb_prerequisites=prerequisite.prerequisites.all.count %}
                  This prerequisite has only one prerequisite itself.
                {% plural %}
                  This prerequisite has {{ nb_prerequisites }} perequisites itself.
                {% endblocktrans %}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  {% endif %}

  <br>


  {# Postrequisites list #}

  {% if module.postrequisites.all.count > 0 %}
    <section class="container p-1 p-md-3 border">
      <div class="text-center">
        <h3>{% trans 'Postrequisites for this module' %}</h3>
      </div>
      <hr>
      {% for postrequisite in module.postrequisites.all %}
        <div class="row row-cols-1 row-cols-md-2 text-center text-md-left">
          <div class="col-md-7">
            <a href="{{ postrequisite.get_absolute_url }}" class="text-reset">
              <span class="h5">{% include 'logo/module.html' %} {{ postrequisite.title }}</span> 
              <span class="small text-muted">{{ postrequisite.reference }}</span>
            </a>
          </div>
          <div class="col-md-5">
            {% if request.user|is_student and request.user|module_already_validated_by_user:postrequisite %}
                <span class="text-success">{% include 'logo/check_valid.html' %} {% trans 'Module already validated' %}</span>
            {% else %}
              <span class="text-info">{% include 'logo/check_info.html' %} 
                {% blocktrans count nb_postrequisitess=postrequisite.prerequisites.all.count %}
                  This postrequisite has only one prerequisite itself.
                {% plural %}
                  This postrequisite has {{ nb_postrequisitess }} perequisites itself.
                {% endblocktrans %}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  {% endif %}

  <br>


  {# Module's courses list #}

  <table class="table table-stripped table-hover table-sm">
    <thead>
      <tr>
        <th scope="col">{% trans 'Course' %}</th>
        <th scope="col">{% trans 'Teacher' %}</th>
        <th scope="col">{% trans 'Start date' %}</th>
        <th scope="col">{% trans 'End date' %}</th>
        <th scope="col">{% trans 'Classroom' %}</th>
        <th scope="col">{% trans 'Free seats left' %}</th>
      </tr>
    </thead>
    <tbody>
      
      {% for course in module.courses.all %}
        {% if course.status != 'FINISHED' %}
          <tr>
            <th scope="row">{{ course.reference }}</th>
            <td>{{ course.teacher.get_full_name }}</td>
            <td>{{ course.date_start }}</td>
            <td>{{ course.date_end }}</td>
            {% if course.room is not None %}
              <td>{{ course.room.name }}</td>
              <td class="text-center">
                <strong class="text-{% if course.over_attendance %}warning{% elif course.max_seats_available == 0 %}danger{% else %}success{% endif %}">
                  {{ course.max_seats_available }}
                </strong>
              </td>
            {% endif %}
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <br>


  {# Back to ListView button #}

  <div class="text-right">
    <a href="{% url 'module_listview' %}" class="btn btn-block btn-outline-dark">
      <h3>
        {% include 'logo/module.html' %} {% trans 'Back to the modules catalog' %} {% include 'logo/back.html' %}
      </h3>
    </a>
  </div>

  <br>

{% endblock content %}
