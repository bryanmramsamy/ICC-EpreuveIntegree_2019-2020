{% extends 'base.html' %}
{% load i18n registration_extra static %}

{% block title %}{{ module.title }} | {{ module.reference }}{% endblock title %}

{% block content %}


  {# Heading jumbotron #}

  <section class="jumbotron jumbotron-fluid" style="background-image: url('{% static 'images/puzzle_02.jpg' %}'); background-attachment: fixed; background-size: 1200px;">
    <div class="container bg-light" style="font-family: papyrus; opacity: 0.9;">
      <div class="row row-cols-1 row-cols-md-2">
        <div class="col col-md-8">
          <h1 class="display-4" style="font-style: italic;">
            {% include 'logo/module.html' %}
            {{ module.title }}
          </h1>
          <hr>
          <p class="lead">
            {{ module.description|linebreaks }}
          </p>
        </div>

        <div class="col col-md-4">
          <img src="{% static 'draws/road_to_knowledge.svg' %}" alt="Degrees catalog" class="img-fluid rounded">
        </div>
      </div>
    </div>
  </section>


  {# Validation restriction bubble #}

  {% if already_validated %}
    <section class="container mb-2">
      <div class="row row-cols-1 row-cols-md-2 bg-success rounded text-light pt-2">
        <div class="col-md-1 text-center text-md-right">
          <h1>{% include 'logo/check.html' %}</h1>
        </div>
        <div class="col-md-11">
          <p class="text-justify">
            <span class="h5 font-weight-bold">
              {% blocktrans %}
                You already have validated this module.
              {% endblocktrans %}
            </span>
            <br>
            {% blocktrans %}
              You don't have to validate this module again. If a postrequisite module is still locked, this means another of its prerequisite module hasn't been validated yet. But this is not the case of this module.
            {% endblocktrans %}
            <br><br>
            {% blocktrans %}
              You are free to subscribe once more to the module in order to get a better result. If you fail, the module will still be considered as validated. But keep in mind your request still have to be approved and you will have to pay the subscribtion fees once again.
            {% endblocktrans %}
          </p>
        </div>
      </div>
    </section>

    <br>

  {% else %}
    {% if all_prerequisites_validated and module.prerequisites.all.count > 0 %}
      <section class="container mb-2">
        <div class="row row-cols-1 row-cols-md-2 bg-info rounded text-light pt-2">
          <div class="col-md-1 text-center text-md-right">
            <h1>{% include 'logo/info.html' %}</h1>
          </div>
          <div class="col-md-11">
            <p class="text-justify">
              <span class="h5 font-weight-bold">
                {% blocktrans %}
                  This module has prerequisites you already validated.
                {% endblocktrans %}
              </span>
              <br>
              {% blocktrans %}
                You can subscribe to this module now without any more conditions.
              {% endblocktrans %}
            </p>
          </div>
        </div>
      </section>

    {% elif module.prerequisites.all.count > 0 %}
      <section class="container mb-2">
        <div class="row row-cols-1 row-cols-md-2 bg-warning rounded text-black pt-2">
          <div class="col-md-1 text-center text-md-right">
            <h1>{% include 'logo/warning.html' %}</h1>
          </div>
          <div class="col-md-11">
            <p class="text-justify">
              <span class="h5 font-weight-bold">
                {% blocktrans %}
                  This module has prerequisites which must be validated in order to validate this module.
                {% endblocktrans %}
              </span>
              <br>
              {% blocktrans %}
                If you didn't acquired the prerequisites yet, you can still subscribe to this module but keep in mind that it won't be considered as validated as long as the prerequisites are not validated yet.
              {% endblocktrans %}
              <br><br>
              {% blocktrans %}
                If you already acquired the prerequisites in another school, you can still go to that module page, subscribe and ask for an examption. If you request is accepted, the module will be considered as validated and you won't have to procceed to its payment. Keep in mind that your request can be denied too.
              {% endblocktrans %}
              <br><br>
              {% blocktrans %}
                Your request still have to be accepted by our staff and payed by yourself in any case.
              {% endblocktrans %}
            </p>
          </div>
        </div>
      </section>
    {% endif %}

    {% if module.postrequisites.all.count > 0 %}
      <section class="container mb-2">
        <div class="row row-cols-1 row-cols-md-2 bg-info rounded text-light pt-2">
          <div class="col-md-1 text-center text-md-right">
            <h1>{% include 'logo/info.html' %}</h1>
          </div>
          <div class="col-md-11">
            <p class="text-justify">
              <span class="h5 font-weight-bold">
                {% blocktrans %}
                  This module has postrequisites and must be validated in order to validate these.
                {% endblocktrans %}
              </span>
              <br>
              {% blocktrans %}
                Some modules has this module has prerequisites, which means you cannot validate them without validate this one.
              {% endblocktrans %}
              <br><br>
              {% blocktrans %}
                If you already passed and succeed this module in another school, you can subscribe and ask for an examption. If you request is accepted, the module will be considered as validated and you won't have to procceed to its payment. Keep in mind that your request can be denied too.
              {% endblocktrans %}
            </p>
          </div>
        </div>
      </section>
    {% endif %}
  {% endif %}

  <br>


  {# Presentation card #}

  <section class="container p-1 p-md-3 border bg-light">
    <div class="row rwo-cols-1 row-cols-lg-2">
      <div class="col-lg-6 text-center">
        <img src="{{ module.picture.url }}" alt="{{ module.title }}" class="img-fluid" style="max-width: 400px; max-height: 300px;"/>
      </div>
      <div class="col-lg-6 text-center">
        <h1>{% include 'logo/module.html' %}</h1>
        <h2>{{ module.title }}</h2>
        <div class="row">
          <div class="col">{{ module.reference }}</div>
          <div class="col">{{ module.level.name }}</div>
        </div>
        <hr>
        <div class="row h3">
          <div class="col">ECTS: <strong>{{ module.ECTS_value }}</strong></div>
          <div class="col">â‚¬ <strong>{{ module.price }}</strong></div>
        </div>
        <hr>

        {% if module.degrees.all.count > 0 %}
        <p>{% trans 'This module is part of the following degrees' %}:</p>
        <ul class="list-unstyled">
          {% for degree in module.degrees.all %}
            <li class="h5">
              <a href="{{ degree.get_absolute_url }}" class="text-reset">
                {% include 'logo/degree.html' %} {{ degree.title }} <small class="text-muted">{{ degree.category.name }}</small>
              </a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p>{% trans 'This module does not belong to any degree.' %}</p>
        {% endif %}
        <hr>

        {% if module.eligible_teachers.all.count > 0 %}
        <p>{% trans 'Teachers of this module' %}:</p>
        <ul class="list-unstyled">
          {% for teacher in module.eligible_teachers.all %}
            <li class="h5">
              {{ teacher.get_full_name }} <a href="mailto:{{ teacher.email }}" class="badge badge-secondary">{% trans 'Contact by mail' %} {% include 'logo/mail.html' %}</a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p>{% trans 'There is actually no eligible teacher for this course.' %}</p>
        {% endif %}
      </div>
    </div>

    <hr>

    {% if request.user|is_student %}
      <a href="404" class="btn btn-block btn-dark">{% trans 'Subscribe to this module' %} {% include 'logo/puzzle.html' %}</a>   <!-- TODO: redirect to module_rr_createview -->
    {% elif request.user|is_manager_or_administrator %}
      <div class="row row-cols-1 row-cols-md-2">
        <div class="col mb-2 mb-md-0">
          <a href="{% url 'module_updateview' pk=module.pk %}" class="btn btn-block btn-warning">{% trans 'Update' %} {% include 'logo/edit.html' %}</a>
        </div>
        <div class="col">
          <a href="{% url 'module_deleteview' pk=module.pk %}" class="btn btn-block btn-danger">{% trans 'Delete' %} {% include 'logo/delete.html' %}</a>
        </div>
      </div>
    {% elif user.is_authenticated %}
      <section class="container mb-2">
        <div class="row row-cols-1 row-cols-md-2 pt-2 rounded text-black bg-warning">
          <div class="col-md-1 text-center text-md-right">
            <h1>{% include 'logo/warning.html' %}</h1>
          </div>
          <div class="col-md-11">
            <p class="text-justify">
              <span class="h5 font-weight-bold">
                {% blocktrans %}
                  You are registered as a guest.
                {% endblocktrans %}
              </span>
              <br>
              {% blocktrans %}
                Register as a student now by submitting your registration report.
              {% endblocktrans %}
            </p>
          </div>
        </div>
      </section>

      <a href="{% url 'student_rr_createview' %}" class="btn btn-block btn-dark">{% trans 'Submit your student registration report' %} {% include 'logo/register_alt.html' %}</a>
    {% else %}
      <section class="container mb-2">
        <div class="row row-cols-1 row-cols-md-2 pt-2 rounded text-black bg-warning">
          <div class="col-md-1 text-center text-md-right">
            <h1>{% include 'logo/warning.html' %}</h1>
          </div>
          <div class="col-md-11">
            <p class="text-justify">
              <span class="h5 font-weight-bold">
                {% blocktrans %}
                  You are not registered.
                {% endblocktrans %}
              </span>
              <br>
              {% blocktrans %}
                Register as a guest and then submit your registration report in order to subscribe to this module.
              {% endblocktrans %}
            </p>
          </div>
        </div>
      </section>

      <div class="row row-cols-1 row-cols-md-2">
        <div class="col mb-2 mb-md-0">
          <a href="{% url 'register' %}" class="btn btn-block btn-dark">{% trans 'Sign up' %} {% include 'logo/register.html' %}</a>
        </div>
        <div class="col">
          <a href="{% url 'login' %}" class="btn btn-block btn-outline-dark">{% trans 'Sign in' %} {% include 'logo/in-left.html' %}</a>
        </div>
      </div>
    {% endif %}
  </section>

  <br>


  {# Prerequisites list #}

  {% if module.prerequisites.all.count > 0 %}
    <section class="container p-1 p-md-3 border">
      <div class="text-center">
        <h3>{% trans 'Prerequisites for this module' %}</h3>
      </div>
      <hr>
      {% for prerequisite in module.prerequisites.all %}
        <div class="row row-cols-1 row-cols-md-2 text-center text-md-left">
          <div class="col-md-7">
            <a href="{{ prerequisite.get_absolute_url }}" class="text-reset">
              <span class="h5">{% include 'logo/module.html' %} {{ prerequisite.title }}</span> 
              <span class="small text-muted">{{ prerequisite.reference }}</span>
            </a>
          </div>
          <div class="col-md-5">
            {% if request.user|is_student %}
              {% if request.user|module_already_validated_by_user:prerequisite %}
                <span class="text-success">{% include 'logo/check_valid.html' %} {% trans 'Module already validated' %}</span>
              {% elif request.user|all_prerequisites_validated_by_user:prerequisite %}
                <span class="text-warning">{% include 'logo/check_ready.html' %} {% trans 'Prerequisites validated' %}</span>
              {% else %}
                <span class="text-danger">{% include 'logo/check_invalid.html' %} {% trans 'Prerequisites missing' %}</span>
              {% endif %}
            {% else %}
              <span class="text-info">{% include 'logo/check_info.html' %} 
                {% blocktrans count nb_prerequisites=prerequisite.prerequisites.all.count %}
                  This prerequisite has only one prerequisite itself.
                {% plural %}
                  This prerequisite has {{ nb_prerequisites }} perequisites itself.
                {% endblocktrans %}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  {% endif %}

  <br>


  {# Postrequisites list #}

  {% if module.postrequisites.all.count > 0 %}
    <section class="container p-1 p-md-3 border">
      <div class="text-center">
        <h3>{% trans 'Postrequisites for this module' %}</h3>
      </div>
      <hr>
      {% for postrequisite in module.postrequisites.all %}
        <div class="row row-cols-1 row-cols-md-2 text-center text-md-left">
          <div class="col-md-7">
            <a href="{{ postrequisite.get_absolute_url }}" class="text-reset">
              <span class="h5">{% include 'logo/module.html' %} {{ postrequisite.title }}</span> 
              <span class="small text-muted">{{ postrequisite.reference }}</span>
            </a>
          </div>
          <div class="col-md-5">
            {% if request.user|is_student and request.user|module_already_validated_by_user:postrequisite %}
                <span class="text-success">{% include 'logo/check_valid.html' %} {% trans 'Module already validated' %}</span>
            {% else %}
              <span class="text-info">{% include 'logo/check_info.html' %} 
                {% blocktrans count nb_postrequisitess=postrequisite.prerequisites.all.count %}
                  This postrequisite has only one prerequisite itself.
                {% plural %}
                  This postrequisite has {{ nb_postrequisitess }} perequisites itself.
                {% endblocktrans %}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  {% endif %}

  <br>


  {# Module's courses list #}

  <table class="table table-stripped table-hover table-sm">
    <thead>
      <tr>
        <th scope="col">{% trans 'Course' %}</th>
        <th scope="col">{% trans 'Teacher' %}</th>
        <th scope="col">{% trans 'Start date' %}</th>
        <th scope="col">{% trans 'End date' %}</th>
        <th scope="col">{% trans 'Classroom' %}</th>
        <th scope="col">{% trans 'Free seats left' %}</th>
      </tr>
    </thead>
    <tbody>
      
      {% for course in module.courses.all %}
        {% if course.status != 'FINISHED' %}
          <tr>
            <th scope="row">{{ course.reference }}</th>
            <td>{{ course.teacher.get_full_name }}</td>
            <td>{{ course.date_start }}</td>
            <td>{{ course.date_end }}</td>
            {% if course.room is not None %}
              <td>{{ course.room.name }}</td>
              <td class="text-center">
                <strong class="text-{% if course.over_attendance %}warning{% elif course.max_seats_available == 0 %}danger{% else %}success{% endif %}">
                  {{ course.max_seats_available }}
                </strong>
              </td>
            {% endif %}
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <br>

  {# Back to ListView button #}

  <div class="text-right">
    <a href="{% url 'module_listview' %}" class="btn p-4 btn-outline-dark">
      <h3>
        {% include 'logo/back.html' %} {% trans 'Back to the module catalog' %}
      </h3>
    </a>
  </div>

  <br>

{% endblock content %}
